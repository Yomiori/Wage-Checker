<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vercel Analytics Diagnostic - SalaryCheck.us</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .diagnostic-container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fafafa;
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .log-output {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="diagnostic-container">
      <h1>üîß Vercel Analytics Diagnostic Tool</h1>
      <p>This tool helps diagnose Vercel Analytics issues on SalaryCheck.us</p>

      <div class="test-section">
        <h2>üìä Analytics Status</h2>
        <div id="analytics-status"></div>
        <button onclick="checkAnalyticsStatus()">Check Analytics Status</button>
      </div>

      <div class="test-section">
        <h2>üåê Network Tests</h2>
        <div id="network-results"></div>
        <button onclick="testNetworkRequests()">Test Network Requests</button>
      </div>

      <div class="test-section">
        <h2>üì¶ Module Loading Tests</h2>
        <div id="module-results"></div>
        <button onclick="testModuleLoading()">Test ES6 Module Loading</button>
      </div>

      <div class="test-section">
        <h2>üéØ Event Tracking Tests</h2>
        <div id="event-results"></div>
        <button onclick="testEventTracking()">Test Event Tracking</button>
      </div>

      <div class="test-section">
        <h2>üìù Console Log</h2>
        <div id="console-log" class="log-output"></div>
        <button onclick="clearLog()">Clear Log</button>
      </div>

      <div class="test-section">
        <h2>üöÄ Quick Fixes</h2>
        <button onclick="forceLoadAnalytics()">Force Load Analytics</button>
        <button onclick="reinitializeAnalytics()">
          Reinitialize Analytics
        </button>
        <button onclick="testFallbackMethod()">Test Fallback Method</button>
      </div>

      <div class="test-section">
        <h2>üîç Comprehensive Verification</h2>
        <div id="verification-results"></div>
        <button onclick="runComprehensiveVerification()">
          Run Full Verification Suite
        </button>
        <button onclick="testAnalyticsEndpoint()">
          Test Analytics Endpoint
        </button>
      </div>
    </div>

    <!-- Load verification script -->
    <script defer src="verify-analytics.js"></script>

    <!-- Load our custom analytics modules -->
    <script type="module">
      import { analytics, inject } from "./js/analytics-module.js";

      window.customAnalytics = analytics;
      await analytics.inject();

      log("‚úÖ Custom analytics module loaded");
    </script>

    <!-- Fallback for non-module browsers -->
    <script nomodule>
      window.va =
        window.va ||
        function () {
          (window.vaq = window.vaq || []).push(arguments);
        };
      log("‚ö†Ô∏è Using fallback analytics implementation");
    </script>
    <script nomodule defer src="/_vercel/insights/script.js"></script>

    <script>
      // Logging function
      function log(message) {
        const timestamp = new Date().toISOString();
        const logElement = document.getElementById("console-log");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById("console-log").textContent = "";
      }

      function addResult(containerId, className, message) {
        const container = document.getElementById(containerId);
        const div = document.createElement("div");
        div.className = `test-result ${className}`;
        div.textContent = message;
        container.appendChild(div);
      }

      // Analytics Status Check
      function checkAnalyticsStatus() {
        const container = document.getElementById("analytics-status");
        container.innerHTML = "";

        // Check window.va
        if (typeof window.va === "function") {
          addResult(
            "analytics-status",
            "success",
            "‚úÖ window.va function available"
          );
        } else {
          addResult(
            "analytics-status",
            "error",
            "‚ùå window.va function not available"
          );
        }

        // Check analytics queue
        if (window.vaq && Array.isArray(window.vaq)) {
          addResult(
            "analytics-status",
            "info",
            `üìä Analytics queue length: ${window.vaq.length}`
          );
        } else {
          addResult(
            "analytics-status",
            "warning",
            "‚ö†Ô∏è Analytics queue not found"
          );
        }

        // Check custom analytics
        if (window.customAnalytics) {
          addResult(
            "analytics-status",
            "success",
            "‚úÖ Custom analytics module available"
          );
        } else {
          addResult(
            "analytics-status",
            "warning",
            "‚ö†Ô∏è Custom analytics module not loaded"
          );
        }

        // Check Vercel script
        const vercelScript = document.querySelector('script[src*="insights"]');
        if (vercelScript) {
          addResult(
            "analytics-status",
            "success",
            "‚úÖ Vercel insights script found in DOM"
          );
        } else {
          addResult(
            "analytics-status",
            "error",
            "‚ùå Vercel insights script not found in DOM"
          );
        }

        log("Analytics status check completed");
      }

      // Network Tests
      async function testNetworkRequests() {
        const container = document.getElementById("network-results");
        container.innerHTML = "";

        // Test Vercel insights script
        try {
          const response = await fetch("/_vercel/insights/script.js");
          if (response.ok) {
            addResult(
              "network-results",
              "success",
              `‚úÖ /_vercel/insights/script.js: ${response.status}`
            );
          } else {
            addResult(
              "network-results",
              "error",
              `‚ùå /_vercel/insights/script.js: ${response.status}`
            );
          }
        } catch (error) {
          addResult(
            "network-results",
            "error",
            `‚ùå /_vercel/insights/script.js: ${error.message}`
          );
        }

        // Test custom modules
        const modules = [
          "./js/analytics-simple.js",
          "./js/analytics-module.js",
        ];
        for (const module of modules) {
          try {
            const response = await fetch(module);
            if (response.ok) {
              addResult(
                "network-results",
                "success",
                `‚úÖ ${module}: ${response.status}`
              );
            } else {
              addResult(
                "network-results",
                "error",
                `‚ùå ${module}: ${response.status}`
              );
            }
          } catch (error) {
            addResult(
              "network-results",
              "error",
              `‚ùå ${module}: ${error.message}`
            );
          }
        }

        log("Network tests completed");
      }

      // Module Loading Tests
      async function testModuleLoading() {
        const container = document.getElementById("module-results");
        container.innerHTML = "";

        // Test analytics-simple.js
        try {
          const simpleModule = await import("./js/analytics-simple.js");
          addResult(
            "module-results",
            "success",
            "‚úÖ analytics-simple.js loaded successfully"
          );

          if (typeof simpleModule.inject === "function") {
            addResult(
              "module-results",
              "success",
              "‚úÖ inject function available in simple module"
            );
          } else {
            addResult(
              "module-results",
              "error",
              "‚ùå inject function not found in simple module"
            );
          }
        } catch (error) {
          addResult(
            "module-results",
            "error",
            `‚ùå analytics-simple.js: ${error.message}`
          );
        }

        // Test analytics-module.js
        try {
          const fullModule = await import("./js/analytics-module.js");
          addResult(
            "module-results",
            "success",
            "‚úÖ analytics-module.js loaded successfully"
          );

          if (fullModule.analytics) {
            addResult(
              "module-results",
              "success",
              "‚úÖ analytics object available in full module"
            );
          } else {
            addResult(
              "module-results",
              "error",
              "‚ùå analytics object not found in full module"
            );
          }
        } catch (error) {
          addResult(
            "module-results",
            "error",
            `‚ùå analytics-module.js: ${error.message}`
          );
        }

        log("Module loading tests completed");
      }

      // Event Tracking Tests
      function testEventTracking() {
        const container = document.getElementById("event-results");
        container.innerHTML = "";

        // Test basic tracking
        if (window.va) {
          try {
            window.va("track", "diagnostic_test", {
              test_type: "basic_tracking",
              timestamp: new Date().toISOString(),
            });
            addResult(
              "event-results",
              "success",
              "‚úÖ Basic event tracking test sent"
            );
          } catch (error) {
            addResult(
              "event-results",
              "error",
              `‚ùå Basic tracking failed: ${error.message}`
            );
          }
        } else {
          addResult(
            "event-results",
            "error",
            "‚ùå Cannot test tracking - window.va not available"
          );
        }

        // Test custom analytics
        if (window.customAnalytics) {
          try {
            window.customAnalytics.track("diagnostic_custom_test", {
              test_type: "custom_tracking",
              timestamp: new Date().toISOString(),
            });
            addResult(
              "event-results",
              "success",
              "‚úÖ Custom analytics tracking test sent"
            );
          } catch (error) {
            addResult(
              "event-results",
              "error",
              `‚ùå Custom tracking failed: ${error.message}`
            );
          }
        } else {
          addResult(
            "event-results",
            "warning",
            "‚ö†Ô∏è Custom analytics not available for testing"
          );
        }

        log("Event tracking tests completed");
      }

      // Quick Fixes
      function forceLoadAnalytics() {
        if (!document.querySelector('script[src*="insights"]')) {
          const script = document.createElement("script");
          script.src = "/_vercel/insights/script.js";
          script.defer = true;
          script.onload = () =>
            log("‚úÖ Analytics script force-loaded successfully");
          script.onerror = () => log("‚ùå Analytics script force-load failed");
          document.head.appendChild(script);
          log("üîÑ Force loading analytics script...");
        } else {
          log("‚ö†Ô∏è Analytics script already present in DOM");
        }
      }

      function reinitializeAnalytics() {
        window.va =
          window.va ||
          function () {
            (window.vaq = window.vaq || []).push(arguments);
          };

        // Track a test event
        window.va("track", "reinitialization_test", {
          timestamp: new Date().toISOString(),
        });

        log("üîÑ Analytics reinitialized and test event sent");
      }

      function testFallbackMethod() {
        // Simple fallback implementation
        if (!window.va) {
          window.va = function () {
            console.log("Fallback analytics call:", arguments);
            (window.vaq = window.vaq || []).push(arguments);
          };
        }

        window.va("track", "fallback_test", {
          method: "fallback",
          timestamp: new Date().toISOString(),
        });

        log("üîÑ Fallback method tested");
      }

      // New comprehensive verification function
      function runComprehensiveVerification() {
        const container = document.getElementById("verification-results");
        container.innerHTML =
          '<div class="test-result info">üîÑ Running comprehensive verification...</div>';

        if (typeof window.verifyAnalytics === "function") {
          window.verifyAnalytics().then((results) => {
            container.innerHTML = "";

            Object.entries(results).forEach(([test, result]) => {
              const className = result ? "success" : "error";
              const status = result ? "‚úÖ" : "‚ùå";
              const testName = test.replace(/([A-Z])/g, " $1").toLowerCase();
              addResult(
                "verification-results",
                className,
                `${status} ${testName}`
              );
            });

            const passed = Object.values(results).filter(Boolean).length;
            const total = Object.keys(results).length;

            if (passed === total) {
              addResult(
                "verification-results",
                "success",
                `üéâ All ${total} tests passed! Analytics working perfectly.`
              );
            } else {
              addResult(
                "verification-results",
                "warning",
                `‚ö†Ô∏è ${passed}/${total} tests passed. Check failed tests above.`
              );
            }
          });
        } else {
          addResult(
            "verification-results",
            "error",
            "‚ùå Verification script not loaded. Please wait and try again."
          );
        }

        log("Comprehensive verification started");
      }

      // Test analytics endpoint directly
      async function testAnalyticsEndpoint() {
        const container = document.getElementById("verification-results");
        container.innerHTML =
          '<div class="test-result info">üîÑ Testing analytics endpoint...</div>';

        try {
          const response = await fetch("/_vercel/insights/script.js", {
            method: "HEAD",
          });
          container.innerHTML = "";

          if (response.ok) {
            addResult(
              "verification-results",
              "success",
              `‚úÖ Analytics endpoint accessible (${response.status})`
            );
            addResult(
              "verification-results",
              "info",
              `üìä Content-Type: ${
                response.headers.get("content-type") || "unknown"
              }`
            );
          } else {
            addResult(
              "verification-results",
              "error",
              `‚ùå Analytics endpoint failed (${response.status})`
            );
            addResult(
              "verification-results",
              "warning",
              "üí° Enable Analytics in Vercel dashboard and redeploy"
            );
          }
        } catch (error) {
          container.innerHTML = "";
          addResult(
            "verification-results",
            "error",
            `‚ùå Network error: ${error.message}`
          );
          addResult(
            "verification-results",
            "warning",
            "üí° Check internet connection and Vercel deployment"
          );
        }

        log("Analytics endpoint test completed");
      }

      // Initialize diagnostic on page load
      window.addEventListener("load", () => {
        log("üîß Vercel Analytics Diagnostic Tool loaded");
        log("üìä Starting automatic checks...");

        setTimeout(() => {
          checkAnalyticsStatus();
        }, 2000);

        // Auto-run comprehensive verification after 5 seconds
        setTimeout(() => {
          if (typeof window.verifyAnalytics === "function") {
            log("üîç Running automatic comprehensive verification...");
            runComprehensiveVerification();
          }
        }, 5000);
      });
    </script>
  </body>
</html>
